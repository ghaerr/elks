name: nanox

on:
  workflow_run:
    workflows: ["main"]
    types:
      - completed

  workflow_dispatch:

jobs:
  nanox:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')

    runs-on: ubuntu-22.04

    permissions:
      actions: read
      contents: read

    steps:
      # ------------------------------------------------------------
      # Setup dependencies
      # ------------------------------------------------------------
      - name: setup
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texinfo \
            libncurses5-dev \
            libelf-dev \
            ncompress \
            git \
            build-essential

      # ------------------------------------------------------------
      # Checkout repo
      # ------------------------------------------------------------
      - name: checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Restore cross toolchain cache
      # ------------------------------------------------------------
      - name: cache
        id: cache
        uses: actions/cache@v4
        with:
          path: cross
          key: cross-${{ hashFiles('tools/*') }}-${{ runner.os }}

      - name: prepare
        if: steps.cache.outputs.cache-hit != 'true'
        run: mkdir -p cross

      - name: build cross toolchain
        if: steps.cache.outputs.cache-hit != 'true'
        run: tools/build.sh

      # ------------------------------------------------------------
      # Download hd32-minix.img from latest successful main run
      # ------------------------------------------------------------
      - name: download hd32-minix image via GitHub API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          mkdir -p image

          RUN_ID=$(gh run list \
            --workflow main \
            --status success \
            --limit 1 \
            --json databaseId \
            -q '.[0].databaseId')

          test -n "$RUN_ID"

          gh run download "$RUN_ID" \
            --name hd32-minix.img \
            --dir image

          test -f image/hd32-minix.img

      # ------------------------------------------------------------
      # Clone ELKS (REQUIRED)
      # ------------------------------------------------------------
      - name: clone ELKS
        run: git clone https://github.com/elks-org/elks.git

      # ------------------------------------------------------------
      # Clone MicroWindows
      # ------------------------------------------------------------
      - name: clone microwindows
        run: git clone https://github.com/ghaerr/microwindows.git

      # ------------------------------------------------------------
      # Build ELKS host tools (FIX)
      # ------------------------------------------------------------
      - name: build ELKS tools
        run: |
          cd "$GITHUB_WORKSPACE/elks"

          rm -f .config include/config.h
          make defconfig
          make -j1 tools

      # ------------------------------------------------------------
      # Build Nano-X for ELKS
      # ------------------------------------------------------------
      - name: build Nano-X for ELKS
        run: |
          cd "$GITHUB_WORKSPACE/elks"
          . ./env.sh

          export PATH="$GITHUB_WORKSPACE/elks/tools/bin:$PATH"

          cd "$GITHUB_WORKSPACE/microwindows/src"
          make -f Makefile.elks

      # ------------------------------------------------------------
      # Install Nano-X into Minix HDD image
      # ------------------------------------------------------------
      - name: install Nano-X into Minix HDD image
        run: |
          cd "$GITHUB_WORKSPACE/elks"
          . ./env.sh

          export PATH="$GITHUB_WORKSPACE/elks/tools/bin:$PATH"

          IMAGE="$GITHUB_WORKSPACE/image/hd32-minix.img"

          "$GITHUB_WORKSPACE/elks/tools/bin/mfs" "$IMAGE" mkdir /bin || true
          "$GITHUB_WORKSPACE/elks/tools/bin/mfs" "$IMAGE" mkdir /lib || true

          for f in "$GITHUB_WORKSPACE"/microwindows/src/bin/*; do
            "$GITHUB_WORKSPACE/elks/tools/bin/mfs" "$IMAGE" cp "$f" /bin
          done

          "$GITHUB_WORKSPACE/elks/tools/bin/mfs" "$IMAGE" \
            cp "$GITHUB_WORKSPACE/microwindows/src/bin/nxworld.map" /lib

          "$GITHUB_WORKSPACE/elks/tools/bin/mfs" "$IMAGE" rm /bin/nxworld.map

      # ------------------------------------------------------------
      # Upload updated image
      # ------------------------------------------------------------
      - name: upload updated Minix HDD image with Nano-X
        uses: actions/upload-artifact@v4
        with:
          name: hd32-minix-nanox.img
          path: image/hd32-minix.img
