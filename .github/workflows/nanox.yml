name: nanox

on:
  workflow_run:
    workflows: ["main"]
    types:
      - completed

jobs:
  nanox:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04

    permissions:
      actions: read
      contents: read

    steps:
      # ------------------------------------------------------------
      # Setup dependencies
      # ------------------------------------------------------------
      - name: setup
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texinfo \
            libncurses5-dev \
            libelf-dev \
            ncompress \
            git \
            build-essential

      # ------------------------------------------------------------
      # Checkout repo (needed for env.sh, tools, etc.)
      # ------------------------------------------------------------
      - name: checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Restore cross toolchain cache (needed for Nano-X build)
      # ------------------------------------------------------------
      - name: cache
        id: cache
        uses: actions/cache@v4
        with:
          path: cross
          key: cross-${{ hashFiles('tools/*') }}-${{ runner.os }}

      - name: prepare
        if: steps.cache.outputs.cache-hit != 'true'
        run: mkdir -p cross

      - name: build cross toolchain
        if: steps.cache.outputs.cache-hit != 'true'
        run: tools/build.sh

      # ------------------------------------------------------------
      # Download hd32-minix.img artifact from "main"
      # ------------------------------------------------------------
      - name: download hd32-minix image
        uses: actions/download-artifact@v4
        with:
          name: hd32-minix.img
          path: image

      # ------------------------------------------------------------
      # Clone MicroWindows
      # ------------------------------------------------------------
      - name: clone microwindows
        run: |
          git clone https://github.com/ghaerr/microwindows.git

      # ------------------------------------------------------------
      # Build Nano-X for ELKS
      # ------------------------------------------------------------
      - name: build Nano-X for ELKS
        run: |
          cd "$GITHUB_WORKSPACE/elks"
          . ./env.sh
          echo "TOPDIR=$TOPDIR"
          test -d "$TOPDIR/elkscmd"

          cd "$GITHUB_WORKSPACE/microwindows/src"
          make -f Makefile.elks

      # ------------------------------------------------------------
      # Install Nano-X into downloaded Minix image
      # ------------------------------------------------------------
      - name: install Nano-X into Minix HDD image
        run: |
          cd "$GITHUB_WORKSPACE/elks"
          . ./env.sh

          IMAGE="$GITHUB_WORKSPACE/image/hd32-minix.img"
          test -f "$IMAGE" || {
            echo "ERROR: hd32-minix.img not found"
            ls -l "$GITHUB_WORKSPACE/image"
            exit 1
          }

          echo "which mfs:"
          which mfs || echo "mfs not found in PATH"

          MFS="$(command -v mfs)"
          echo "Using mfs at: $MFS"

          if [ -z "$MFS" ] || [ ! -x "$MFS" ]; then
            echo "ERROR: mfs not found or not executable"
            exit 1
          fi

          # Copy Nano-X binaries into /bin
          for f in "$GITHUB_WORKSPACE"/microwindows/src/bin/*; do
            echo "Installing $(basename "$f") into /bin"
            "$MFS" "$IMAGE" cp "$f" /bin
          done

          # Move nxworld.map to /lib (host â†’ image, then remove from /bin)
          "$MFS" "$IMAGE" cp "$GITHUB_WORKSPACE/microwindows/src/bin/nxworld.map" /lib
          "$MFS" "$IMAGE" rm /bin/nxworld.map

      # ------------------------------------------------------------
      # Upload updated image
      # ------------------------------------------------------------
      - name: upload updated Minix HDD image with Nano-X
        uses: actions/upload-artifact@v4
        with:
          name: hd32-minix-nanox.img
          path: image/hd32-minix.img
